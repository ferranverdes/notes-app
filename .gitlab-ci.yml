stages: [test]

default:
  image: node:22-alpine
  before_script:
    - cd app

# Reuse deps between pipelines
cache:
  key:
    files:
      - app/package-lock.json       # refresh cache when lockfile changes
  paths:
    - app/node_modules/             # cache installed modules
    - app/.npm/                     # cache npm package tarballs
  policy: pull-push                 # pull existing cache before job; update it after completion

test:
  stage: test
  variables:
    NODE_ENV: "test"
    DATABASE_URL: "file:./test.db"
  script:
    - npm ci --cache .npm --prefer-offline # install deps using cached packages when available
    - npm test -- --ci  # npm stops parsing flags; runs Jest in CI mode
